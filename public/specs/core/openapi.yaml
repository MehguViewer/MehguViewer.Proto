openapi: 3.1.0
info:
  title: MehguViewer Core API
  version: 1.0.0
  description: |
    The Content Delivery API for the MehguViewer Federated Protocol.
    Handles Manga/Anime/Novel content, Comments, and Votes.
servers:
  - url: https://core.mehgu.example.com
    description: Production Core Server

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # User URN
    UserURN:
      type: string
      pattern: '^urn:mvn:user:[0-9a-fA-F-]{36}$'
      example: 'urn:mvn:user:123e4567-e89b-12d3-a456-426614174000'

    # Series URN
    SeriesURN:
      type: string
      pattern: '^urn:mvn:series:[0-9a-fA-F-]{36}$'
      example: 'urn:mvn:series:123e4567-e89b-12d3-a456-426614174000'

    # Federation Reference
    FederationRef:
      type: string
      pattern: '^urn:src:[a-z0-9]+:[a-zA-Z0-9-]+$'
      example: 'urn:src:anilist:21'
      nullable: true
      description: External reference for federation merging.

    # RFC 7807 Problem Details
    Problem:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
      required:
        - type
        - title
        - status

    # Pagination
    CursorPagination:
      type: object
      properties:
        next_cursor:
          type: string
          nullable: true
        has_more:
          type: boolean
      required:
        - has_more

    # Author Snapshot
    AuthorSnapshot:
      type: object
      properties:
        uid:
          $ref: '#/components/schemas/UserURN'
        display_name:
          type: string
        avatar_url:
          type: string
          format: uri
        role_badge:
          type: string
          enum: [admin, moderator, translator, user]
      required:
        - uid
        - display_name

    # Comment
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        author:
          $ref: '#/components/schemas/AuthorSnapshot'
        created_at:
          type: string
          format: date-time
        vote_count:
          type: integer
      required:
        - id
        - content
        - author

    # Series (Polymorphic)
    Series:
      type: object
      oneOf:
        - $ref: '#/components/schemas/MangaSeries'
        - $ref: '#/components/schemas/VideoSeries'
        - $ref: '#/components/schemas/NovelSeries'
      discriminator:
        propertyName: media_type
        mapping:
          MANGA: '#/components/schemas/MangaSeries'
          VIDEO: '#/components/schemas/VideoSeries'
          NOVEL: '#/components/schemas/NovelSeries'

    # Base Series Properties
    BaseSeries:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/SeriesURN'
        federation_ref:
          $ref: '#/components/schemas/FederationRef'
        title:
          type: string
        description:
          type: string
        poster:
          type: object
          properties:
            url:
              type: string
              format: uri
            alt_text:
              type: string
          required:
            - url
            - alt_text
        media_type:
          type: string
          enum: [MANGA, VIDEO, NOVEL]
      required:
        - id
        - title
        - poster
        - media_type

    # Manga Series
    MangaSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object
          properties:
            reading_direction:
              type: string
              enum: [LTR, RTL, TTB]
          required:
            - reading_direction

    # Video Series (Anime)
    VideoSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object
          properties:
            duration_seconds:
              type: integer
              description: Average duration of an episode.
          required:
            - duration_seconds

    # Novel Series
    NovelSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object

    # Vote
    Vote:
      type: object
      properties:
        target_id:
          type: string
          pattern: '^urn:mvn:(series|comment):[0-9a-fA-F-]{36}$'
          description: URN of the Comment or Series being voted on.
        target_type:
          type: string
          enum: [comment, series]
        value:
          type: integer
          enum: [1, -1, 0]
          description: 1 for Upvote, -1 for Downvote, 0 to remove vote.
      required:
        - target_id
        - target_type
        - value

paths:
  /api/v1/series:
    get:
      summary: List Series
      description: Get a list of series with cursor pagination.
      operationId: listSeries
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: type
          in: query
          schema:
            type: string
            enum: [manga, anime, novel]
      responses:
        '200':
          description: List of series
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=60, s-maxage=300"
              description: Caching directives for performance.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Series'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'

  /api/v1/series/{seriesId}:
    get:
      summary: Get Series Details
      operationId: getSeries
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Series details
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=300"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Series'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/series/{seriesId}/units:
    get:
      summary: List Units (Chapters)
      operationId: listUnits
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of units
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=60"
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Unit'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'

  /api/v1/comments:
    get:
      summary: List Comments
      operationId: listComments
      parameters:
        - name: target_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'
    post:
      summary: Post Comment
      operationId: createComment
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target_id:
                  type: string
                  format: uuid
                content:
                  type: string
              required:
                - target_id
                - content
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/votes:
    post:
      summary: Cast Vote
      operationId: castVote
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Vote'
      responses:
        '200':
          description: Vote recorded
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

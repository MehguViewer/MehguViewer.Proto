openapi: 3.1.0
info:
  title: MehguViewer Core API
  version: 1.0.0
  description: |
    The Content Delivery API for the MehguViewer Federated Protocol.
    Handles Manga/Anime/Novel content, Comments, and Votes.
servers:
  - url: https://core.mehgu.example.com
    description: Production Core Server

components:
  headers:
    X-RateLimit-Limit:
      description: The maximum number of requests that the consumer is permitted to make per minute.
      schema:
        type: integer
    X-RateLimit-Remaining:
      description: The number of requests remaining in the current rate limit window.
      schema:
        type: integer
    Access-Control-Allow-Origin:
      description: Indicates whether the response can be shared with requesting code from the given origin.
      schema:
        type: string
    Server-Timing:
      description: Communicates one or more metrics and descriptions for the given request-response cycle.
      schema:
        type: string

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # User URN
    UserURN:
      type: string
      pattern: '^urn:mvn:user:[0-9a-fA-F-]{36}$'
      example: 'urn:mvn:user:123e4567-e89b-12d3-a456-426614174000'

    # Series URN
    SeriesURN:
      type: string
      pattern: '^urn:mvn:series:[0-9a-fA-F-]{36}$'
      example: 'urn:mvn:series:123e4567-e89b-12d3-a456-426614174000'

    # Federation Reference
    FederationRef:
      type: string
      pattern: '^urn:src:[a-z0-9]+:[a-zA-Z0-9-]+$'
      example: 'urn:src:anilist:21'
      nullable: true
      description: External reference for federation merging.

    # RFC 7807 Problem Details
    Problem:
      type: object
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
        detail:
          type: string
        instance:
          type: string
          format: uri
      required:
        - type
        - title
        - status

    # Pagination
    CursorPagination:
      type: object
      properties:
        next_cursor:
          type: string
          nullable: true
        has_more:
          type: boolean
      required:
        - has_more

    # Author Snapshot
    AuthorSnapshot:
      type: object
      properties:
        uid:
          $ref: '#/components/schemas/UserURN'
        display_name:
          type: string
        avatar_url:
          type: string
          format: uri
        role_badge:
          type: string
          enum: [admin, moderator, translator, user]
      required:
        - uid
        - display_name

    # Series Create
    SeriesCreate:
      type: object
      properties:
        title:
          type: string
        description:
          type: string
        media_type:
          type: string
          enum: [MANGA, VIDEO, NOVEL]
        reading_direction:
          type: string
          enum: [LTR, RTL, TTB]
          description: Required for MANGA
        duration_seconds:
          type: integer
          description: Required for VIDEO
      required:
        - title
        - media_type

    # Search Results
    SearchResults:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Series'
        meta:
          $ref: '#/components/schemas/CursorPagination'

    # Comment
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        author:
          $ref: '#/components/schemas/AuthorSnapshot'
        created_at:
          type: string
          format: date-time
        vote_count:
          type: integer
      required:
        - id
        - content
        - author

    # Series (Polymorphic)
    Series:
      type: object
      oneOf:
        - $ref: '#/components/schemas/MangaSeries'
        - $ref: '#/components/schemas/VideoSeries'
        - $ref: '#/components/schemas/NovelSeries'
      discriminator:
        propertyName: media_type
        mapping:
          MANGA: '#/components/schemas/MangaSeries'
          VIDEO: '#/components/schemas/VideoSeries'
          NOVEL: '#/components/schemas/NovelSeries'

    # Base Series Properties
    BaseSeries:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/SeriesURN'
        federation_ref:
          $ref: '#/components/schemas/FederationRef'
        title:
          type: string
        description:
          type: string
        poster:
          type: object
          properties:
            url:
              type: string
              format: uri
            alt_text:
              type: string
          required:
            - url
            - alt_text
        media_type:
          type: string
          enum: [MANGA, VIDEO, NOVEL]
      required:
        - id
        - title
        - poster
        - media_type

    # Manga Series
    MangaSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object
          properties:
            reading_direction:
              type: string
              enum: [LTR, RTL, TTB]
          required:
            - reading_direction

    # Video Series (Anime)
    VideoSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object
          properties:
            duration_seconds:
              type: integer
              description: Average duration of an episode.
          required:
            - duration_seconds

    # Novel Series
    NovelSeries:
      allOf:
        - $ref: '#/components/schemas/BaseSeries'
        - type: object

    # Vote
    Vote:
      type: object
      properties:
        target_id:
          type: string
          pattern: '^urn:mvn:(series|comment):[0-9a-fA-F-]{36}$'
          description: URN of the Comment or Series being voted on.
        target_type:
          type: string
          enum: [comment, series]
        value:
          type: integer
          enum: [1, -1, 0]
          description: 1 for Upvote, -1 for Downvote, 0 to remove vote.
      required:
        - target_id
        - target_type
        - value

    # Unit (Chapter/Episode)
    Unit:
      type: object
      properties:
        id:
          type: string
          format: uuid
        series_id:
          $ref: '#/components/schemas/SeriesURN'
        unit_number:
          type: number
          description: The chapter or episode number (e.g., 1, 1.5).
        title:
          type: string
        created_at:
          type: string
          format: date-time
      required:
        - id
        - series_id
        - unit_number

    # Unit Create (Manual)
    UnitCreate:
      type: object
      properties:
        unit_number:
          type: number
        title:
          type: string
      required:
        - unit_number

    # Page
    Page:
      type: object
      properties:
        page_number:
          type: integer
        asset_urn:
          type: string
          description: The URN of the image asset.
        url:
          type: string
          format: uri
          description: External CDN URL (if not hosted locally).
      required:
        - page_number

    # Reading Progress
    ReadingProgress:
      type: object
      properties:
        series_urn:
          $ref: '#/components/schemas/SeriesURN'
        chapter_id:
          type: string
        page_number:
          type: integer
        status:
          type: string
          enum: [reading, completed, dropped, plan_to_read]
        updated_at:
          type: integer
          format: int64
          description: UNIX timestamp (ms)
      required:
        - series_urn
        - chapter_id
        - page_number
        - status
        - updated_at

    # Collection
    Collection:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        is_system:
          type: boolean
          description: If true, this is a default list (e.g., READING) and cannot be deleted.
        items:
          type: array
          items:
            $ref: '#/components/schemas/SeriesURN'
      required:
        - id
        - name
        - is_system

    # Report
    Report:
      type: object
      properties:
        target_urn:
          type: string
          description: URN of the content being reported.
        reason:
          type: string
          description: Explanation of the violation.
        severity:
          type: string
          enum: [spam, harassment, spoiler, other]
      required:
        - target_urn
        - reason
        - severity

paths:
  /.well-known/mehgu-node:
    get:
      summary: Node Discovery
      description: Returns the public identity and capabilities of this node.
      operationId: getWellKnownNode
      security: []
      responses:
        '200':
          description: Node Metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                  node_name:
                    type: string
                  description:
                    type: string
                  auth_server:
                    type: string
                    format: uri
                  capabilities:
                    type: object
                    properties:
                      search:
                        type: boolean
                      streaming:
                        type: boolean
                      download:
                        type: boolean
                  maintainer:
                    type: object
                    properties:
                      name:
                        type: string
                      email:
                        type: string
                        format: email
                required:
                  - version
                  - node_name
                  - auth_server

  /api/v1/instance:
    get:
      summary: Get Node Manifest
      description: Returns the public manifest of this MehguViewer Core Node.
      operationId: getInstance
      security: []
      responses:
        '200':
          description: Node Manifest
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            Access-Control-Allow-Origin:
              $ref: '#/components/headers/Access-Control-Allow-Origin'
            Server-Timing:
              $ref: '#/components/headers/Server-Timing'
          content:
            application/json:
              schema:
                type: object
                properties:
                  urn:
                    type: string
                    pattern: '^urn:mvn:node:[0-9a-fA-F-]{36}$'
                    example: "urn:mvn:node:123e4567-e89b-12d3-a456-426614174000"
                  name:
                    type: string
                    example: "Kazeo's Manga Server"
                  description:
                    type: string
                    example: "A private node for Shonen Jump archives."
                  version:
                    type: string
                    example: "1.0.0"
                  software:
                    type: string
                    example: "MehguViewer.Core (NativeAOT)"
                  capabilities:
                    type: array
                    items:
                      type: string
                      enum: [MANGA, VIDEO, NOVEL]
                  image_cdn_url:
                    type: string
                    format: uri
                    nullable: true
                    description: "Optional base URL for direct CDN access. If present, clients can construct image URLs directly."
                    example: "https://cdn.mehgu.example.com"
                  registration_open:
                    type: boolean
                    example: false
                  contact:
                    type: object
                    properties:
                      email:
                        type: string
                        format: email
                required:
                  - urn
                  - name
                  - version
                  - software
                  - capabilities
                  - registration_open

  /api/v1/assets/{asset_urn}:
    get:
      summary: Resolve Asset
      description: |
        Resolves a URN to a binary file.
        Supports standard Bearer Auth OR a `?token=` query param for use in `<img>` tags.
      operationId: getAsset
      security:
        - BearerAuth: []
        - {} # Allow optional auth if token param is used
      parameters:
        - name: asset_urn
          in: path
          required: true
          schema:
            type: string
          description: The URN of the image/video asset.
        - name: token
          in: query
          schema:
            type: string
          description: Alternative to Bearer Header for browser tags.
      responses:
        '200':
          description: Binary Content
          content:
            image/*:
              schema:
                type: string
                format: binary
            video/*:
              schema:
                type: string
                format: binary
        '307':
          description: Temporary Redirect to CDN
          headers:
            Location:
              schema:
                type: string
                format: uri
              description: The direct CDN URL.
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (User does not have access to parent series)
        '404':
          description: Asset Not Found

  /api/v1/search:
    get:
      summary: Advanced Search
      description: Search for content with filters and sorting.
      operationId: searchContent
      tags: [Discovery]
      parameters:
        - name: q
          in: query
          schema:
            type: string
          description: Full text search query.
        - name: type
          in: query
          schema:
            type: string
            enum: [SERIES, ARTIST, CHARACTER]
        - name: genres
          in: query
          schema:
            type: array
            items:
              type: string
          description: List of genres (AND logic).
        - name: status
          in: query
          schema:
            type: string
            enum: [ONGOING, COMPLETED, HIATUS]
        - name: sort
          in: query
          schema:
            type: string
            enum: [UPDATED_AT, POPULARITY, ALPHABETICAL]
            default: UPDATED_AT
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Search Results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResults'

  /api/v1/series:
    post:
      summary: Create Series
      description: Create a new Series metadata entry.
      operationId: createSeries
      tags: [Management]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeriesCreate'
      responses:
        '201':
          description: Series Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Series'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (Admin only)
    get:
      summary: List Series
      description: Get a list of series with cursor pagination.
      operationId: listSeries
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: type
          in: query
          schema:
            type: string
            enum: [manga, anime, novel]
      responses:
        '200':
          description: List of series
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=60, s-maxage=300"
              description: Caching directives for performance.
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Series'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'

  /api/v1/series/{seriesId}:
    get:
      summary: Get Series Details
      operationId: getSeries
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Series details
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=300"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Series'
        '404':
          description: Not Found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/series/{seriesId}/chapters:
    post:
      summary: Upload Chapter (Bulk)
      description: |
        Upload a chapter archive (.zip, .cbz, .epub).
        The server will unpack, hash assets, and generate URNs asynchronously.
      operationId: uploadChapter
      tags: [Management]
      security:
        - BearerAuth: []
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                  description: The chapter archive file.
                metadata:
                  type: string
                  description: JSON string containing title, number, language.
                  example: '{"title": "Chapter 1", "number": 1, "language": "en"}'
                parser_config:
                  type: string
                  description: JSON string configuring the parser (e.g., regex for filenames).
                  example: '{"mode": "regex", "pattern": "(\\d+).jpg"}'
              required:
                - file
                - metadata
      responses:
        '202':
          description: Accepted for Processing
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: "processing"
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (Admin only)

  /api/v1/series/{seriesId}/units:
    post:
      summary: Create Unit (Manual)
      description: Create a chapter/episode container for manual page uploading.
      operationId: createUnit
      tags: [Management]
      security:
        - BearerAuth: []
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnitCreate'
      responses:
        '201':
          description: Unit Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Unit'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (Admin only)
    get:
      summary: List Units (Chapters)
      operationId: listUnits
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of units
          headers:
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=60"
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Unit'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'

  /api/v1/units/{unitId}/pages:
    post:
      summary: Add Page to Unit
      description: Upload a single page image OR register an external CDN URL.
      operationId: addPage
      tags: [Management]
      security:
        - BearerAuth: []
      parameters:
        - name: unitId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                page_number:
                  type: integer
                file:
                  type: string
                  format: binary
                  description: The image file (optional if url is provided).
              required:
                - page_number
          application/json:
            schema:
              type: object
              properties:
                page_number:
                  type: integer
                url:
                  type: string
                  format: uri
                  description: External CDN URL.
              required:
                - page_number
                - url
      responses:
        '201':
          description: Page Added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Page'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /api/v1/series/{seriesId}/progress:
    put:
      summary: Update Read Progress
      description: Updates the user's bookmark for this series.
      operationId: updateSeriesProgress
      security:
        - BearerAuth: []
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                last_read_chapter_id:
                  type: string
                  description: The URN/ID of the chapter.
                page_number:
                  type: integer
                  description: The page number the user stopped at.
                completed:
                  type: boolean
                  description: Whether the user has finished the series.
              required:
                - last_read_chapter_id
                - page_number
      responses:
        '200':
          description: Progress Updated
        '204':
          description: Progress Updated (No Content)
        '400':
          description: Invalid Input
        '401':
          description: Unauthorized
    get:
      summary: Get Read Progress
      description: Returns the user's current position in this series.
      operationId: getSeriesProgress
      security:
        - BearerAuth: []
      parameters:
        - name: seriesId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Current Progress
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadingProgress'
        '401':
          description: Unauthorized
        '404':
          description: No progress found for this series

  /api/v1/comments:
    get:
      summary: List Comments
      description: Fetch comments for a Series, Chapter, or another Comment (replies).
      operationId: listComments
      tags: [Social]
      parameters:
        - name: target_urn
          in: query
          required: true
          schema:
            type: string
          description: The URN of the Series, Unit, or Comment.
        - name: depth
          in: query
          schema:
            type: integer
            default: 1
          description: How many levels of replies to fetch.
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of comments
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Comment'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'
    post:
      summary: Post Comment
      description: Post a new comment or reply. Triggers author snapshot logic.
      operationId: createComment
      tags: [Social]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target_urn:
                  type: string
                  description: The URN of the target entity.
                body_markdown:
                  type: string
                  description: The comment content in Markdown.
                spoiler:
                  type: boolean
                  default: false
              required:
                - target_urn
                - body_markdown
      responses:
        '201':
          description: Comment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Comment'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/votes:
    post:
      summary: Cast Vote
      operationId: castVote
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Vote'
      responses:
        '200':
          description: Vote recorded
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/me/history:
    get:
      summary: Get Reading History
      description: Returns a paginated list of series the user has interacted with.
      operationId: getHistory
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: History List
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ReadingProgress'
                  meta:
                    type: object
                    properties:
                      total:
                        type: integer
                      has_more:
                        type: boolean

  /api/v1/me/progress:
    post:
      summary: Sync Reading Progress
      description: Push a progress update for a specific series.
      operationId: syncProgress
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReadingProgress'
      responses:
        '200':
          description: Progress Synced
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/me/library:
    get:
      summary: Get Library State
      description: Pull the latest progress for all series.
      operationId: getLibrary
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Library State
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReadingProgress'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/collections:
    get:
      summary: List Collections
      description: Returns user's created lists and default system lists.
      operationId: listCollections
      tags: [Library]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of Collections
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Collection'
        '401':
          description: Unauthorized
    post:
      summary: Create Collection
      description: Create a custom list (e.g., "Isekai Trash").
      operationId: createCollection
      tags: [Library]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
                - name
      responses:
        '201':
          description: Collection Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Collection'
        '401':
          description: Unauthorized

  /api/v1/collections/{collection_id}/items:
    post:
      summary: Add Item to Collection
      operationId: addCollectionItem
      tags: [Library]
      security:
        - BearerAuth: []
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                target_urn:
                  $ref: '#/components/schemas/SeriesURN'
              required:
                - target_urn
      responses:
        '200':
          description: Item Added
        '401':
          description: Unauthorized
        '404':
          description: Collection Not Found

  /api/v1/collections/{collection_id}/items/{urn}:
    delete:
      summary: Remove Item from Collection
      operationId: removeCollectionItem
      tags: [Library]
      security:
        - BearerAuth: []
      parameters:
        - name: collection_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: urn
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/SeriesURN'
      responses:
        '204':
          description: Item Removed
        '401':
          description: Unauthorized
        '404':
          description: Collection or Item Not Found

  /api/v1/reports:
    post:
      summary: Submit Report
      description: Flag content for moderation.
      operationId: createReport
      tags: [Moderation]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Report'
      responses:
        '202':
          description: Report Accepted
        '401':
          description: Unauthorized

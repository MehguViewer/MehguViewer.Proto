openapi: 3.1.0
info:
  title: MehguViewer Auth API
  version: 1.0.0
  description: |
    The Identity Provider for the MehguViewer Federated Protocol.
    Handles Authentication, Global User Profiles, and Security.
servers:
  - url: https://auth.mehgu.example.com
    description: Production Auth Server

components:
  headers:
    X-RateLimit-Limit:
      description: The maximum number of requests that the consumer is permitted to make per minute.
      schema:
        type: integer
    X-RateLimit-Remaining:
      description: The number of requests remaining in the current rate limit window.
      schema:
        type: integer
    Access-Control-Allow-Origin:
      description: Indicates whether the response can be shared with requesting code from the given origin.
      schema:
        type: string
    Server-Timing:
      description: Communicates one or more metrics and descriptions for the given request-response cycle.
      schema:
        type: string

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # User URN
    UserURN:
      type: string
      pattern: '^urn:mvn:user:[0-9a-fA-F-]{36}$'
      example: 'urn:mvn:user:123e4567-e89b-12d3-a456-426614174000'
      description: Unique Uniform Resource Name for a User.

    # RFC 7807 Problem Details
    Problem:
      type: object
      properties:
        type:
          type: string
          format: uri
          description: A URI reference that identifies the problem type.
        title:
          type: string
          description: A short, human-readable summary of the problem type.
        status:
          type: integer
          description: The HTTP status code.
        detail:
          type: string
          description: A human-readable explanation specific to this occurrence of the problem.
        instance:
          type: string
          format: uri
          description: A URI reference that identifies the specific occurrence of the problem.
      required:
        - type
        - title
        - status

    # User Profile
    UserProfile:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/UserURN'
        username:
          type: string
        avatar_url:
          type: string
          format: uri
          description: Accessible URL for the user avatar.
        global_level:
          type: integer
          description: Global experience level across the federation.
        global_xp:
          type: integer
          description: Total experience points.
        created_at:
          type: string
          format: date-time
      required:
        - id
        - username
        - global_level
        - global_xp

    # Session
    Session:
      type: object
      properties:
        id:
          type: string
          format: uuid
        device_name:
          type: string
          description: User-friendly name of the device (e.g., "Chrome on macOS").
        last_active:
          type: string
          format: date-time
        ip_address:
          type: string
          format: ipv4
        is_current:
          type: boolean
      required:
        - id
        - device_name
        - last_active

    # Relationship (Block/Mute)
    Relationship:
      type: object
      properties:
        target_user_id:
          $ref: '#/components/schemas/UserURN'
        type:
          type: string
          enum: [block, mute]
        created_at:
          type: string
          format: date-time
      required:
        - target_user_id
        - type

    # Pagination
    CursorPagination:
      type: object
      properties:
        next_cursor:
          type: string
          nullable: true
        has_more:
          type: boolean
      required:
        - has_more

    # Preferences
    Preferences:
      type: object
      properties:
        blocked_user_ids:
          type: array
          items:
            $ref: '#/components/schemas/UserURN'
          description: List of User IDs that the current user has blocked.
      required:
        - blocked_user_ids

paths:
  /.well-known/openid-configuration:
    get:
      summary: OIDC Discovery
      description: Returns OpenID Connect configuration.
      operationId: getOidcConfiguration
      responses:
        '200':
          description: OIDC Configuration
          content:
            application/json:
              schema:
                type: object
                properties:
                  issuer:
                    type: string
                  authorization_endpoint:
                    type: string
                  token_endpoint:
                    type: string
                  jwks_uri:
                    type: string
                  response_types_supported:
                    type: array
                    items:
                      type: string
                  subject_types_supported:
                    type: array
                    items:
                      type: string
                  id_token_signing_alg_values_supported:
                    type: array
                    items:
                      type: string

  /.well-known/jwks.json:
    get:
      summary: JSON Web Key Set
      description: Returns the public keys used to verify tokens.
      operationId: getJwks
      responses:
        '200':
          description: JWKS
          content:
            application/json:
              schema:
                type: object
                properties:
                  keys:
                    type: array
                    items:
                      type: object
                      properties:
                        kty:
                          type: string
                        use:
                          type: string
                        kid:
                          type: string
                        alg:
                          type: string
                        n:
                          type: string
                        e:
                          type: string

  /oauth/token:
    post:
      summary: Request Access Token
      description: Exchange credentials for an Access Token (JWT).
      operationId: getToken
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                grant_type:
                  type: string
                  enum: [password, refresh_token]
                username:
                  type: string
                password:
                  type: string
                refresh_token:
                  type: string
                client_id:
                  type: string
              required:
                - grant_type
                - client_id
      responses:
        '200':
          description: Access Token
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  token_type:
                    type: string
                    example: Bearer
                  expires_in:
                    type: integer
                  refresh_token:
                    type: string
                required:
                  - access_token
                  - token_type
                  - expires_in
        '400':
          description: Invalid Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/me:
    get:
      summary: Get Current User Profile
      description: Returns the profile of the authenticated user, including global stats.
      operationId: getMe
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User Profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/me/preferences:
    get:
      summary: Get Global Preferences
      description: Returns global user preferences, including the blocklist.
      operationId: getPreferences
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User Preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Preferences'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/me/relationships:
    get:
      summary: Get Global Blocklist/Mutes
      description: List users blocked or muted by the current user.
      operationId: getRelationships
      security:
        - BearerAuth: []
      parameters:
        - name: cursor
          in: query
          schema:
            type: string
          description: Cursor for pagination.
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of relationships
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Relationship'
                  meta:
                    $ref: '#/components/schemas/CursorPagination'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
    patch:
      summary: Update Relationship
      description: Block or mute a user.
      operationId: updateRelationship
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Relationship'
      responses:
        '204':
          description: Relationship updated
        '400':
          description: Invalid request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/sessions:
    get:
      summary: List Active Sessions
      description: View all active sessions for the user.
      operationId: getSessions
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of sessions
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            Access-Control-Allow-Origin:
              $ref: '#/components/headers/Access-Control-Allow-Origin'
            Server-Timing:
              $ref: '#/components/headers/Server-Timing'
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Session'
    delete:
      summary: Revoke All Other Sessions
      description: Log out all other devices except the current one.
      operationId: revokeAllSessions
      security:
        - BearerAuth: []
      responses:
        '204':
          description: Sessions revoked
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            Access-Control-Allow-Origin:
              $ref: '#/components/headers/Access-Control-Allow-Origin'
            Server-Timing:
              $ref: '#/components/headers/Server-Timing'
        '401':
          description: Unauthorized
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /api/v1/sessions/{sessionId}:
    delete:
      summary: Revoke Session
      description: Revoke a specific session (refresh token).
      operationId: revokeSession
      security:
        - BearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Session revoked
          headers:
            X-RateLimit-Limit:
              $ref: '#/components/headers/X-RateLimit-Limit'
            X-RateLimit-Remaining:
              $ref: '#/components/headers/X-RateLimit-Remaining'
            Access-Control-Allow-Origin:
              $ref: '#/components/headers/Access-Control-Allow-Origin'
            Server-Timing:
              $ref: '#/components/headers/Server-Timing'
        '404':
          description: Session not found
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
